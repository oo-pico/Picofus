<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Picofus ‚Äì Tracker</title>

  <style>
    :root{
      --bg:#0e0e0f; --panel:#151517; --panel-soft:#1b1b1e; --stroke:#26262a;
      --text:#e6e6e6; --muted:#9a9a9a; --gold:#d6b36a; --gold-soft:#b89a55;
      --bad:#ff4d4d; --good:#45d07a; --shadow:0 12px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:radial-gradient(1200px 600px at 30% -10%, rgba(214,179,106,.08), transparent 60%),
                 radial-gradient(900px 500px at 110% 10%, rgba(214,179,106,.06), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1150px;margin:0 auto;padding:22px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:16px;
      padding:14px 16px;border:1px solid var(--stroke);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow:var(--shadow);
      position:sticky;top:10px;z-index:20;backdrop-filter:blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(214,179,106,.35), rgba(214,179,106,.05));
      border:1px solid rgba(214,179,106,.35);
      display:grid;place-items:center;
      font-weight:800;color:var(--gold);
    }
    .brand h1{font-size:16px;margin:0;line-height:1}
    .brand p{margin:0;color:var(--muted);font-size:12px}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .08s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{border-color:rgba(214,179,106,.45);background:rgba(214,179,106,.07)}
    .btn:active{transform:translateY(1px)}
    .btn.gold{border-color:rgba(214,179,106,.55);background:rgba(214,179,106,.08)}
    .btn.bad{border-color:rgba(255,77,77,.5);background:rgba(255,77,77,.08)}
    .btn.good{border-color:rgba(69,208,122,.5);background:rgba(69,208,122,.08)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:13px}

    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--stroke);background:rgba(255,255,255,.02);
      padding:7px 10px;border-radius:999px;
      display:inline-flex;align-items:center;gap:8px;
      max-width:360px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .navIco{width:16px;height:16px;object-fit:contain;display:inline-block}

    main{padding-top:18px}

    .grid{display:grid;grid-template-columns:repeat(3, minmax(0, 1fr));gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2, minmax(0, 1fr))} }
    @media (max-width: 620px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;gap:14px;align-items:center;justify-content:space-between;
    }
    .card-left{display:flex;gap:12px;align-items:center;min-width:0}
    .thumb{
      width:54px;height:54px;border-radius:16px;
      border:1px solid rgba(214,179,106,.25);
      background:rgba(214,179,106,.06);
      display:grid;place-items:center;overflow:hidden;
    }
    .thumb img{width:100%;height:100%;object-fit:contain;image-rendering:auto}
    .card h3{margin:0;font-size:15px}
    .card p{margin:3px 0 0;color:var(--muted);font-size:12px}
    .card-right{display:flex;gap:8px;align-items:center;flex-shrink:0}

    .section{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .topline{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .title{display:flex;gap:12px;align-items:center;min-width:0;}
    .title h2{margin:0;font-size:18px}
    .title .sub{margin:0;color:var(--muted);font-size:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media (max-width: 980px){ .row{grid-template-columns:1fr} }

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:grid;
      grid-template-columns:42px 1fr auto;
      gap:10px;align-items:center;
      padding:10px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background:rgba(255,255,255,.02);
    }
    .ico{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(214,179,106,.18);
      background:rgba(214,179,106,.05);
      display:grid;place-items:center;overflow:hidden;
    }
    .ico img{width:100%;height:100%;object-fit:contain}
    .name{min-width:0}
    .name .n{font-size:14px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .name .m{font-size:12px;margin:2px 0 0;color:var(--muted)}
    .ctrls{display:flex;gap:8px;align-items:center}
    .num{
      min-width:64px;text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:700;
      padding:8px 10px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      cursor:pointer;
    }
    .field{
      width:110px;
      padding:8px 10px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-variant-numeric:tabular-nums;
    }
    .field:focus{border-color:rgba(214,179,106,.55)}
    .mini{width:92px}

    .summary{display:grid;grid-template-columns:repeat(4, minmax(0, 1fr));gap:10px;margin-top:12px;}
    @media (max-width: 980px){ .summary{grid-template-columns:repeat(2, minmax(0, 1fr))} }
    .kpi{border:1px solid var(--stroke);border-radius:16px;background:rgba(255,255,255,.02);padding:10px;}
    .kpi .k{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .kpi .k .kico{width:16px;height:16px;display:inline-grid;place-items:center}
    .kpi .k .kico img{width:16px;height:16px;object-fit:contain}
    .kpi .v{margin-top:6px;font-size:16px;font-weight:800;font-variant-numeric:tabular-nums}
    .kpi .v.gold{color:var(--gold)}
    .hint{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}

    /* ====== MODAL / KEYPAD (opaque) ====== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.72);display:none;align-items:center;justify-content:center;padding:18px;z-index:99;}
    .modal.open{display:flex}
    .kbd{
      width:min(420px, 100%);
      border:1px solid var(--stroke);
      border-radius:22px;
      background:linear-gradient(180deg, #1b1b1e, #121214);
      box-shadow:0 25px 60px rgba(0,0,0,.75);
      padding:14px;
    }
    .kbd-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .kbd-top .label{color:var(--muted);font-size:12px}
    .kbd-top .target{font-weight:800}
    .kbd-display{
      border:1px solid var(--stroke);
      background:#0b0b0c;
      border-radius:18px;
      padding:12px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:12px;
    }
    .kbd-display .val{font-size:22px;font-weight:900;font-variant-numeric:tabular-nums}
    .kbd-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:10px;}
    .kbd-key{
      border:1px solid var(--stroke);
      background:#18181a;
      color:var(--text);
      border-radius:16px;
      padding:14px 10px;
      font-size:16px;
      cursor:pointer;
    }
    .kbd-key:hover{border-color:rgba(214,179,106,.45);background:#1f1f22}
    .kbd-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .kbd-actions .btn{flex:1}
    .kbd-actions .btn.small{flex:0 0 auto}
    .mono{font-variant-numeric:tabular-nums}

    /* ====== mini layout calculators ====== */
    .calc3{display:grid;grid-template-columns:1.05fr 1.25fr .9fr;gap:14px;align-items:start}
    @media (max-width: 980px){ .calc3{grid-template-columns:1fr} }
    .calcBox{
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .calcHead{
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-bottom:1px solid var(--stroke);
      font-size:12px;color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .calcBody{padding:12px}
    .calcValue{
      display:flex;align-items:center;justify-content:center;
      font-size:22px;font-weight:900;
      font-variant-numeric:tabular-nums;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px 10px;
      cursor:pointer;
    }
    .calcValue.static{cursor:default}
    .calcStack{display:flex;flex-direction:column;gap:10px}
    .calcRow{
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.12);
      border-radius:16px;
      padding:10px;
    }
    .calcRow .lab{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.05em}
    .calcRow .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .calcRightBig{
      border:1px solid rgba(214,179,106,.45);
      background:linear-gradient(180deg, rgba(214,179,106,.14), rgba(214,179,106,.06));
      border-radius:var(--r);
      padding:12px;
    }
    .calcRightBig .t{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .calcRightBig .v{
      margin-top:8px;
      font-size:30px;font-weight:950;color:var(--gold);
      font-variant-numeric:tabular-nums;
      display:flex;justify-content:center;align-items:center;gap:10px;
      padding:14px 10px;border-radius:16px;
      border:1px solid rgba(214,179,106,.35);
      background:rgba(0,0,0,.18);
      cursor:pointer;
    }
    .calcNote{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35}
    .fieldPct{width:120px}

    /* ====== Songes helpers ====== */
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .seg .btn{padding:8px 10px;border-radius:999px}
    .seg .btn.active{border-color:rgba(214,179,106,.65);background:rgba(214,179,106,.10)}
    .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .searchRow input{
      flex:1;min-width:180px;
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .searchRow input:focus{border-color:rgba(214,179,106,.55)}

    /* ====== Legends: 2 par ligne ====== */
    .legendGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){ .legendGrid{grid-template-columns:1fr} }
    .legendItem .name .n{max-width:100%}
    .legendItem .ctrls .btn.small{padding:8px 9px}
    .legendItem .num{min-width:72px}
  </style>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <header id="topHeader">
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <h1>Picofus ‚Äì Tracker</h1>
          <p>Compteurs donjons / mobs / ressources + saisie pav√© num√©rique</p>
        </div>
      </div>

      <div class="nav">
        <span class="pill" id="pagePill">Accueil</span>
        <span class="pill" id="authPill">üîí Local</span>

        <button class="btn small" id="btnTabHome">üè† Home</button>

        <button class="btn small" id="btnTabDonjons">
          <img class="navIco" data-file="Ic√¥ne Dj.png" alt=""> Donjons
        </button>

        <button class="btn small" id="btnTabSonges">
          <img class="navIco" data-file="Bribe de r√™ve.png" alt=""> Songes
        </button>

        <button class="btn small" id="btnTabAnomalies">
          <img class="navIco" data-file="Ic√¥ne anomalie.png" alt=""> Anomalies
        </button>

        <button class="btn small" id="btnTabPP">
          <img class="navIco" data-file="Ic√¥ne Calculateur PP.png" alt=""> Calculateur PP
        </button>

        <button class="btn small" id="btnTabOmega">
          <img class="navIco" data-file="Ic√¥ne Calculateur Omega.png" alt=""> XP Om√©ga
        </button>

        <button class="btn small good" id="btnAuth">üîë Connexion</button>
        <button class="btn small bad" id="btnResetAll">üßπ Reset tout</button>
      </div>
    </header>

    <main id="app"></main>
  </div>

  <div class="modal" id="modal">
    <div class="kbd" role="dialog" aria-modal="true">
      <div class="kbd-top">
        <div>
          <div class="label">Saisie pav√© num√©rique</div>
          <div class="target" id="kbdTarget">‚Äî</div>
        </div>
        <button class="btn small" id="kbdClose">‚úñ</button>
      </div>

      <div class="kbd-display">
        <div class="label">Valeur</div>
        <div class="val mono" id="kbdValue">0</div>
      </div>

      <div class="kbd-grid" id="kbdGrid"></div>

      <div class="kbd-actions">
        <button class="btn bad" id="kbdClear">C</button>
        <button class="btn" id="kbdBack">‚å´</button>
        <button class="btn gold" id="kbdOk">Valider</button>
      </div>

      <div class="hint">
        Clique sur un nombre pour saisir. <b>Valider</b> applique la valeur. <b>C</b> remet √† 0.
      </div>
    </div>
  </div>

<script>
/* =========================================================
   SUPABASE CONFIG (d√©j√† rempli avec tes infos)
   ========================================================= */
const SUPABASE_URL = "https://pktrtwqavqbhdhtzkocy.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_VpU8DwxA2rkt0rAgoeWwiQ_dKL_ubXL";
const SUPABASE_TABLE = "saves"; // table: user_id(uuid PK), data(jsonb), updated_at(timestamptz)

/* =========================================================
   GLOBALS / STORAGE
   ========================================================= */
const LS_PREFIX = "picofus:v3:";
const CLOUD_META_KEY = `${LS_PREFIX}cloud_meta`; // local metadata (timestamp)
const fmt = new Intl.NumberFormat("fr-FR");

function n(v){ return Number.isFinite(v) ? v : 0; }
function clampNonNeg(x){ x = Math.trunc(Number(x)||0); return x < 0 ? 0 : x; }
function f2(x){ return (Number(x)||0).toFixed(2); }
function clampPct(x){
  x = Number(String(x).replace(",", "."));
  if(!Number.isFinite(x)) x = 0;
  return x < 0 ? 0 : x;
}

function resetAll(){
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith(LS_PREFIX)) localStorage.removeItem(k); });
  scheduleCloudSave();
}

/* =========================================================
   IMAGE FALLBACK (ultra robuste)
   ========================================================= */
function uniq(arr){
  const seen = new Set();
  const out = [];
  for(const x of arr){
    if(!x) continue;
    if(seen.has(x)) continue;
    seen.add(x);
    out.push(x);
  }
  return out;
}
function withDot(dir){ return dir.startsWith("./") ? dir : "./" + dir; }
function stripDot(dir){ return dir.startsWith("./") ? dir.slice(2) : dir; }
function encPath(p){ try { return encodeURI(p); } catch { return p; } }
function makeCandidates(imgDir, file){
  const d1 = stripDot(imgDir || "");
  const d2 = withDot(imgDir || "");
  const f1 = file || "";
  return uniq([
    d1 + f1,
    d2 + f1,
    encPath(d1 + f1),
    encPath(d2 + f1),
    f1,
    "./" + f1,
    encPath(f1),
    encPath("./" + f1),
    "img/" + f1,
    "./img/" + f1,
    "images/" + f1,
    "./images/" + f1,
    "assets/" + f1,
    "./assets/" + f1,
  ]);
}
function attachFallback(imgEl, imgDir, file){
  const list = makeCandidates(imgDir, file);
  imgEl.dataset.candidates = JSON.stringify(list);
  imgEl.dataset.idx = "0";
  imgEl.src = list[0];
  imgEl.onerror = () => {
    const candidates = JSON.parse(imgEl.dataset.candidates || "[]");
    let idx = parseInt(imgEl.dataset.idx || "0", 10) + 1;
    imgEl.dataset.idx = String(idx);
    if(idx < candidates.length) imgEl.src = candidates[idx];
    else imgEl.onerror = null;
  };
}
function activateFallbackIn(containerEl, defaultDir){
  if(!containerEl) return; // ‚úÖ √©vite le crash si l'√©l√©ment n'existe pas
  containerEl.querySelectorAll("img").forEach(img=>{
    const file = img.getAttribute("data-file") || (img.getAttribute("src")||"").split("/").pop();
    const dir  = img.getAttribute("data-dir") || defaultDir || "";
    if(file) attachFallback(img, dir, file);
  });
}
  containerEl.querySelectorAll("img").forEach(img=>{
    const file = img.getAttribute("data-file") || (img.getAttribute("src")||"").split("/").pop();
    const dir  = img.getAttribute("data-dir") || defaultDir || "";
    if(file) attachFallback(img, dir, file);
  });
}

/* =========================================================
   SUPABASE SYNC (localStorage <-> table saves)
   ========================================================= */
let supabase = null;
let cloud = { ready:false, user:null, saving:false, saveTimer:null, lastCloudUpdatedAt:null };

function initSupabase(){
  try{
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY) return null;
    return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }catch(e){
    console.error("Supabase init error:", e);
    return null;
  }
}
supabase = initSupabase();

function getLocalCloudMeta(){
  try{ return JSON.parse(localStorage.getItem(CLOUD_META_KEY) || "null"); }
  catch{ return null; }
}
function setLocalCloudMeta(meta){
  localStorage.setItem(CLOUD_META_KEY, JSON.stringify(meta));
}

function collectPrefixedLocalStorage(){
  const ls = {};
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(LS_PREFIX) && k !== CLOUD_META_KEY){
      ls[k] = localStorage.getItem(k);
    }
  }
  return ls;
}
function replacePrefixedLocalStorage(lsMap){
  // remove existing
  for(const k of Object.keys(localStorage)){
    if(k.startsWith(LS_PREFIX) && k !== CLOUD_META_KEY){
      localStorage.removeItem(k);
    }
  }
  // set new
  for(const [k,v] of Object.entries(lsMap || {})){
    if(k.startsWith(LS_PREFIX) && k !== CLOUD_META_KEY){
      localStorage.setItem(k, v);
    }
  }
}

async function loadFromCloudIntoLocal(){
  if(!supabase || !cloud.user) return false;
  try{
    const { data, error } = await supabase
      .from(SUPABASE_TABLE)
      .select("data, updated_at")
      .eq("user_id", cloud.user.id)
      .maybeSingle();

    if(error){
      console.error("Cloud load error:", error);
      return false;
    }
    if(!data || !data.data) return false;

    const payload = data.data;
    const cloudUpdatedAt = data.updated_at ? new Date(data.updated_at).getTime() : Date.now();

    // decide overwrite: if cloud newer than local meta -> overwrite; else keep local
    const localMeta = getLocalCloudMeta();
    const localUpdatedAt = localMeta?.localUpdatedAt ? Number(localMeta.localUpdatedAt) : 0;

    if(cloudUpdatedAt >= localUpdatedAt){
      replacePrefixedLocalStorage(payload.ls || {});
      setLocalCloudMeta({ localUpdatedAt: cloudUpdatedAt, lastCloudUpdatedAt: cloudUpdatedAt });
      cloud.lastCloudUpdatedAt = cloudUpdatedAt;
      return true;
    }else{
      // local is newer -> keep local, push later
      cloud.lastCloudUpdatedAt = cloudUpdatedAt;
      return false;
    }
  }catch(e){
    console.error("Cloud load exception:", e);
    return false;
  }
}

async function saveLocalToCloudNow(){
  if(!supabase || !cloud.user) return;
  try{
    cloud.saving = true;
    updateAuthUI();

    const ls = collectPrefixedLocalStorage();
    const payload = {
      version: 1,
      savedAt: new Date().toISOString(),
      ls
    };

    const { error } = await supabase
      .from(SUPABASE_TABLE)
      .upsert({
        user_id: cloud.user.id,
        data: payload,
        updated_at: new Date().toISOString(),
      }, { onConflict: "user_id" });

    if(error){
      console.error("Cloud save error:", error);
      return;
    }
    const now = Date.now();
    setLocalCloudMeta({ localUpdatedAt: now, lastCloudUpdatedAt: cloud.lastCloudUpdatedAt || now });
  }catch(e){
    console.error("Cloud save exception:", e);
  }finally{
    cloud.saving = false;
    updateAuthUI();
  }
}

function scheduleCloudSave(){
  if(!supabase || !cloud.user) return;
  if(cloud.saveTimer) clearTimeout(cloud.saveTimer);
  cloud.saveTimer = setTimeout(()=>saveLocalToCloudNow(), 900);
}

/* Auth UI / Actions */
const authPill = document.getElementById("authPill");
const btnAuth = document.getElementById("btnAuth");

function updateAuthUI(){
  if(!supabase){
    authPill.textContent = "‚ö†Ô∏è Supabase OFF";
    btnAuth.textContent = "üîë Connexion";
    btnAuth.classList.remove("bad");
    btnAuth.classList.add("good");
    return;
  }
  if(cloud.user){
    const email = cloud.user.email || "connect√©";
    authPill.textContent = cloud.saving ? `‚òÅÔ∏è Sync‚Ä¶ ${email}` : `‚òÅÔ∏è Cloud ${email}`;
    btnAuth.textContent = "üö™ D√©connexion";
    btnAuth.classList.remove("good");
    btnAuth.classList.add("bad");
  }else{
    authPill.textContent = "üîí Local";
    btnAuth.textContent = "üîë Connexion";
    btnAuth.classList.remove("bad");
    btnAuth.classList.add("good");
  }
}

async function doLogin(){
  if(!supabase) return alert("Supabase non initialis√© (URL/Key manquantes).");
  const email = prompt("Email pour connexion (magic link) :");
  if(!email) return;

  const redirectTo = window.location.origin + "/#/";
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: redirectTo }
  });

  if(error){
    console.error(error);
    alert("Erreur connexion: " + (error.message || "unknown"));
    return;
  }
  alert("‚úÖ Lien envoy√© par email. Ouvre-le pour te connecter (retour sur le site).");
}

async function doLogout(){
  if(!supabase) return;
  const { error } = await supabase.auth.signOut();
  if(error){
    console.error(error);
    alert("Erreur d√©connexion: " + (error.message || "unknown"));
  }
}

btnAuth.addEventListener("click", ()=>{
  if(cloud.user) doLogout();
  else doLogin();
});

async function initAuth(){
  if(!supabase) { updateAuthUI(); return; }

  const { data } = await supabase.auth.getSession();
  cloud.user = data?.session?.user || null;
  updateAuthUI();

  if(cloud.user){
    await loadFromCloudIntoLocal();
  }

  supabase.auth.onAuthStateChange(async (_event, session)=>{
    cloud.user = session?.user || null;
    updateAuthUI();
    if(cloud.user){
      await loadFromCloudIntoLocal();
      render();
      scheduleCloudSave(); // ensure we push if local newer
    }else{
      render();
    }
  });
}

/* =========================================================
   KEY PAD (numeric)
   ========================================================= */
const modal = document.getElementById("modal");
const kbdTarget = document.getElementById("kbdTarget");
const kbdValue = document.getElementById("kbdValue");
const kbdGrid = document.getElementById("kbdGrid");
const btnClose = document.getElementById("kbdClose");
const btnClear = document.getElementById("kbdClear");
const btnBack = document.getElementById("kbdBack");
const btnOk = document.getElementById("kbdOk");

let keypad = { open:false, buffer:"0", onApply:null, title:"" };

function openKeypad(title, currentValue, onApply){
  keypad.open = true;
  keypad.title = title;
  keypad.buffer = String(clampNonNeg(currentValue));
  keypad.onApply = onApply;
  kbdTarget.textContent = title;
  kbdValue.textContent = keypad.buffer;
  modal.classList.add("open");
}
function closeKeypad(){ keypad.open = false; modal.classList.remove("open"); }
function setBuffer(next){ keypad.buffer = next; kbdValue.textContent = keypad.buffer; }
function pushDigit(d){ if(keypad.buffer === "0") setBuffer(String(d)); else setBuffer(keypad.buffer + String(d)); }
function backspace(){ if(keypad.buffer.length <= 1) setBuffer("0"); else setBuffer(keypad.buffer.slice(0,-1)); }
function clearBuf(){ setBuffer("0"); }
function applyBuf(){
  const val = clampNonNeg(parseInt(keypad.buffer,10));
  if(typeof keypad.onApply === "function") keypad.onApply(val);
  closeKeypad();
}
(function buildKeypad(){
  kbdGrid.innerHTML = "";
  for(let i=1;i<=9;i++){
    const b = document.createElement("button");
    b.className = "kbd-key";
    b.textContent = String(i);
    b.addEventListener("click", ()=>pushDigit(i));
    kbdGrid.appendChild(b);
  }
  const blank1 = document.createElement("div");
  const zero = document.createElement("button");
  zero.className = "kbd-key";
  zero.textContent = "0";
  zero.addEventListener("click", ()=>pushDigit(0));
  const blank2 = document.createElement("div");
  kbdGrid.appendChild(blank1);
  kbdGrid.appendChild(zero);
  kbdGrid.appendChild(blank2);
})();
btnClose.addEventListener("click", closeKeypad);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeKeypad(); });
btnClear.addEventListener("click", clearBuf);
btnBack.addEventListener("click", backspace);
btnOk.addEventListener("click", applyBuf);
window.addEventListener("keydown", (e)=>{
  if(!keypad.open) return;
  if(e.key >= "0" && e.key <= "9") pushDigit(e.key);
  else if(e.key === "Backspace") backspace();
  else if(e.key === "Escape") closeKeypad();
  else if(e.key === "Enter") applyBuf();
});

/* =========================================================
   ROUTER / APP ROOT
   ========================================================= */
const app = document.getElementById("app");
const pagePill = document.getElementById("pagePill");

document.getElementById("btnTabHome").addEventListener("click", ()=>{ location.hash = "#/"; });
document.getElementById("btnTabDonjons").addEventListener("click", ()=>{ location.hash = "#/donjons"; });
document.getElementById("btnTabSonges").addEventListener("click", ()=>{ location.hash = "#/songes"; });
document.getElementById("btnTabAnomalies").addEventListener("click", ()=>{ location.hash = "#/anomalies"; });
document.getElementById("btnTabPP").addEventListener("click", ()=>{ location.hash = "#/pp"; });
document.getElementById("btnTabOmega").addEventListener("click", ()=>{ location.hash = "#/omega"; });

document.getElementById("btnResetAll").addEventListener("click", ()=>{
  if(confirm("Reset TOUTES les donn√©es (tous les donjons + Songes + calculateurs) ?")){
    resetAll();
    render();
  }
});

function getRoute(){
  const h = location.hash.replace("#","").trim();
  if(!h || h === "/") return { page:"home" };
  if(h === "/donjons") return { page:"donjons" };
  if(h === "/songes") return { page:"songes" };
  if(h === "/anomalies") return { page:"anomalies" };
  if(h === "/pp") return { page:"pp" };
  if(h === "/omega") return { page:"omega" };
  const m = h.match(/^\/d\/([^\/]+)$/);
  if(m) return { page:"dungeon", id:m[1] };
  return { page:"home" };
}
window.addEventListener("hashchange", render);

/* =========================================================
   DONJONS DATA
   ========================================================= */
const DUNGEONS = [
  {
    id: "dechireuse",
    name: "D√©chireuse",
    thumb: "D√©chireuse.png",
    imgDir: "D√©chireuse/",
    totalButtonLabel: "Total donjon (+1 run)",
    totalIncrements: { "D√©chireuse": 1, "Domptueuse": 13, "√âbourifauve": 13, "Voracle": 13 },
    mobs: [
      { key:"D√©chireuse", img:"D√©chireuse.png" },
      { key:"Domptueuse", img:"Domptueuse.png" },
      { key:"√âbourifauve", img:"√âbourifauve.png" },
      { key:"Voracle", img:"Voracle.png" },
    ],
    resources: [
      { key:"Toison de la D√©chireuse", img:"Toison de la D√©chireuse.png" },
      { key:"Griffe de la D√©chireuse", img:"Griffe de la D√©chireuse.png" },
      { key:"Tresse de Domptueuse", img:"Tresse de Domptueuse.png" },
      { key:"Frange d'√âbourifauve", img:"Frange d'√âbourifauve.png" },
      { key:"Mise en plis de Voracle", img:"Mise en plis de Voracle.png" },
      { key:"Daguosseuse de Domptueuse", img:"Daguosseuse de Domptueuse.png" },
      { key:"Bandeau d'√âbourifauve", img:"Bandeau d'√âbourifauve.png" },
      { key:"Os Divinatoire de Voracle", img:"Os Divinatoire de Voracle.png" },
      { key:"Squame du Graogarm", img:"Squame du Graogarm.png" },
      { key:"Peigne de Rhoarim", img:"Peigne de Rhoarim.png" },
      { key:"Viande Go√ªtue", img:"Viande Go√ªtue.png" },
      { key:"Bidoche Go√ªtue", img:"Bidoche Go√ªtue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
      { key:"Uniforme de chasseur-mangeur", img:"Uniforme de chasseur-mangeur.png" },
    ],
  },
  {
    id: "tempetes",
    name: "Temp√™tes √âliocalypse",
    thumb: "servitude.png",
    imgDir: "4 cavaliers/",
    totalButtonLabel: "Total donjon (+1 run)",
    totalIncrements: {
      "Servitude": 1, "Guerre": 1, "Corruption": 1, "Mis√®re": 1,
      "Arm√©cr√©ante": 1, "Olgoth": 1, "Pistilangue": 1, "Ferailleur": 1
    },
    mobs: [
      { key:"Servitude", img:"servitude.png" },
      { key:"Guerre", img:"guerre.png" },
      { key:"Corruption", img:"Corruption.png" },
      { key:"Mis√®re", img:"Mis√®re.png" },
      { key:"Arm√©cr√©ante", img:"Arm√©cr√©ante.png" },
      { key:"Olgoth", img:"Olgoth.png" },
      { key:"Pistilangue", img:"Langue de Pistilangue.png" },
      { key:"Ferailleur", img:"ferrailleur.png" },
    ],
    resources: [
      { key:"Verrou de Servitude", img:"Verrou de Servitude.png" },
      { key:"Bonnet de Guerre", img:"Bonnet de Guerre.png" },
      { key:"Corne de Corruption", img:"Corne de Corruption.png" },
      { key:"Plume de Mis√®re", img:"Plume de Mis√®re.png" },
      { key:"Capuche d'Arm√©cr√©ante", img:"Capuche d'Arm√©cr√©ante.png" },
      { key:"Fragment d'armure", img:"Fragment d'armure.png" },
      { key:"Langue de Pistilangue", img:"Langue de Pistilangue.png" },
      { key:"√âpauli√®re de Ferrailleur", img:"√âpauli√®re de Ferrailleur.png" },
      { key:"Viande Go√ªtue", img:"Viande Go√ªtue.png" },
      { key:"Bidoche Go√ªtue", img:"Bidoche Go√ªtue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
    ],
  },
  {
    id: "bethel",
    name: "Bethel Akarna",
    thumb: "Bethel Akarna.png",
    imgDir: "Bethel/",
    totalButtonLabel: "Total donjon (+1 run)",
    totalIncrements: {
      "Bethel": 1, "Cr√¢nonier": 7, "Funespadon": 7, "Macrab": 11, "Tournoy√©": 7, "Zombruth": 7
    },
    mobs: [
      { key:"Bethel", img:"Bethel Akarna.png" },
      { key:"Cr√¢nonier", img:"Cr√¢nonier.png" },
      { key:"Funespadon", img:"Funespadon.png" },
      { key:"Macrab", img:"Macrab.png" },
      { key:"Tournoy√©", img:"Tournoy√©.png" },
      { key:"Zombruth", img:"Zombruth.png" },
    ],
    resources: [
      { key:"Queue de Bethel Akarna", img:"Queue de Bethel Akarna.png" },
      { key:"Coquille de Submerg√©", img:"Coquille de Submerg√©.png" },
      { key:"Aquarakne de Cr√¢nonier", img:"Aquarakne de Cr√¢nonier.png" },
      { key:"Protection de Funespadon", img:"Protection de Funespadon.png" },
      { key:"Bout d'Armure de Macrab", img:"Bout d'Armure de Macrab.png" },
      { key:"Pointe de Lance de Tournoy√©", img:"Pointe de Lance de Tournoy√©.png" },
      { key:"Chair de Zombruth", img:"Chair de Zombruth.png" },
      { key:"Viande Go√ªtue", img:"Viande Go√ªtue.png" },
      { key:"Bidoche Go√ªtue", img:"Bidoche Go√ªtue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
    ],
  },
  {
    id: "eternel",
    name: "√âternel Conflit",
    thumb: "L'√âternel Conflit.png",
    imgDir: "Eternel conflit/",
    totalButtonLabel: "Total donjon (+1 run)",
    totalIncrements: {
      "√âternel Conflit": 1, "Brutasmodan": 8, "D√©moloch": 8, "Diab√©lial": 8, "Mal√©phisto": 8, "Typhomet": 7
    },
    mobs: [
      { key:"√âternel Conflit", img:"L'√âternel Conflit.png" },
      { key:"Brutasmodan", img:"Brutasmodan.png" },
      { key:"D√©moloch", img:"D√©moloch.png" },
      { key:"Diab√©lial", img:"Diab√©lial.png" },
      { key:"Mal√©phisto", img:"Mal√©phisto.png" },
      { key:"Typhomet", img:"Typhomet.png" },
    ],
    resources: [
      { key:"Masque cauchemardesque de l'√âternel Conflit", img:"Masque cauchemardesque de l'√âternel Conflit.png" },
      { key:"Pic de Ravageur", img:"Pic de Ravageur.png" },
      { key:"M√¢choire de Brutasmodan", img:"M√¢choire de Brutasmodan.png" },
      { key:"Tentacule de D√©moloch", img:"Tentacule de D√©moloch.png" },
      { key:"Langue de Diab√©lial", img:"Langue de Diab√©lial.png" },
      { key:"√âpaule de Mal√©phisto", img:"√âpaule de Mal√©phisto.png" },
      { key:"Corne de Typhomet", img:"Corne de Typhomet.png" },
      { key:"Viande Go√ªtue", img:"Viande Go√ªtue.png" },
      { key:"Bidoche Go√ªtue", img:"Bidoche Go√ªtue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
      { key:"Shuclier", img:"Shuclier.png" },
    ],
  },
  {
    id: "torke",
    name: "Tork√©lonia",
    thumb: "Tork√©lonia.png",
    imgDir: "Tork√©lonia/",
    totalButtonLabel: "Total donjon (+1 run)",
    totalIncrements: { "Tork√©lonia": 1, "Alashasss": 7, "Cronnibal": 8, "Ca√Øguille": 9, "Voapah": 7, "Kashkaille": 8 },
    mobs: [
      { key:"Tork√©lonia", img:"Tork√©lonia.png" },
      { key:"Alashasss", img:"Alashasss.png" },
      { key:"Cronnibal", img:"Cronnibal.png" },
      { key:"Ca√Øguille", img:"Ca√Øguille.png" },
      { key:"Voapah", img:"Voapah.png" },
      { key:"Kashkaille", img:"Kashkaille.png" },
    ],
    resources: [
      { key:"√âcaille de Tork√©lonia", img:"√âcaille de Tork√©lonia.png" },
      { key:"≈íil de Crocodaille albinos", img:"≈íil de Crocodaille albinos.png" },
      { key:"Pagne d'Alashasss", img:"Pagne d'Alashasss.png" },
      { key:"Canine de Cronnibal", img:"Canine de Cronnibal.png" },
      { key:"Poup√©e de Ca√Øguille", img:"Poup√©e de Ca√Øguille.png" },
      { key:"Bandeau de Voapah", img:"Bandeau de Voapah.png" },
      { key:"Langue de Kashkaille", img:"Langue de Kashkaille.png" },
      { key:"Viande Go√ªtue", img:"Viande Go√ªtue.png" },
      { key:"Bidoche Go√ªtue", img:"Bidoche Go√ªtue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
      { key:"Torvil", img:"Torvil.png" },
    ],
  },
  {
    id: "venerable",
    name: "V√©n√©rable Endormi",
    thumb: "V√©n√©rable Endormi.png",
    imgDir: "V√©n√©rable endormi/",
    totalButtonLabel: "Total donjon (+1 run)",
    totalIncrements: { "V√©n√©rable Endormi": 1, "Brutapir": 8, "Lapilope": 8, "Gyrafor": 10, "Gropotam": 7, "Amphibouc": 6 },
    mobs: [
      { key:"V√©n√©rable Endormi", img:"V√©n√©rable Endormi.png" },
      { key:"Brutapir", img:"Brutapir.png" },
      { key:"Lapilope", img:"Lapilope.png" },
      { key:"Gyrafor", img:"Gyrafor.png" },
      { key:"Gropotam", img:"Gropotam.png" },
      { key:"Amphibouc", img:"Amphibouc.png" },
    ],
    resources: [
      { key:"Corne du V√©n√©rable Endormi", img:"Corne du V√©n√©rable Endormi.png" },
      { key:"Crini√®re du V√©n√©rable Endormi", img:"Crini√®re du V√©n√©rable Endormi.png" },
      { key:"D√©fense de Brutapir", img:"D√©fense de Brutapir.png" },
      { key:"Corne de Lapilope", img:"Corne de Lapilope.png" },
      { key:"Corne de Gyrafor", img:"Corne de Gyrafor.png" },
      { key:"Front osseux de Gropotam", img:"Front osseux de Gropotam.png" },
      { key:"Corne d'Amphibouc", img:"Corne d'Amphibouc.png" },
      { key:"Groin de Brutapir", img:"Groin de Brutapir.png" },
      { key:"Oreille de Lapilope", img:"Oreille de Lapilope.png" },
      { key:"Lampe de Gyrafor", img:"Lampe de Gyrafor.png" },
      { key:"M√¢choire de Gropotam", img:"M√¢choire de Gropotam.png" },
      { key:"Langue d'Amphibouc", img:"Langue d'Amphibouc.png" },
      { key:"Squame du Graogarm", img:"Squame du Graogarm.png" },
      { key:"Peau de zarbivore", img:"Peau de zarbivore.png" },
      { key:"Viande Go√ªtue", img:"Viande Go√ªtue.png" },
      { key:"Bidoche Go√ªtue", img:"Bidoche Go√ªtue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
      { key:"Uniforme de chasseur-mangeur", img:"Uniforme de chasseur-mangeur.png" },
    ],
  },
  {
    id: "comte",
    name: "Comte Harebourg",
    thumb: "comte.png",
    imgDir: "Comte/",
    totalButtonLabel: "Total donjon (+1 run)",
    // ‚úÖ FIX : +1 sur "Comte Harebourg" (le nom r√©el affich√©)
    totalIncrements: { "Comte Harebourg": 1, "Sinistrofu": 6, "Noctu": 9, "Cyclo": 9, "Granduk": 8, "Strigide": 7 },
    mobs: [
      { key:"Comte Harebourg", img:"comte.png" },
      { key:"Granduk", img:"granduk.png" },
      { key:"Strigide", img:"strigide.png" },
      { key:"Sinistrofu", img:"sinistrofu.png" },
      { key:"Noctu", img:"noctu.png" },
      { key:"Cyclo", img:"cyclo.png" },
    ],
    resources: [
      { key:"Bandelette de Comte", img:"bandelette comte.png" },
      { key:"Scapula du Comte", img:"scapu comte.png" },
      { key:"Pic de Noctu", img:"pic de noctu.png" },
      { key:"Bec de Granduk", img:"bec de granduk.png" },
      { key:"Bec de Strigide", img:"bec de strigide.png" },
      { key:"Plume Cyclo", img:"plume cyclo.png" },
      { key:"Aile de Noctu", img:"aille de noctu.png" },
      { key:"Aile de Sinistrofu", img:"aille de sinistrofu.png" },
      { key:"Queue de Sini", img:"queue de sini.png" },
      { key:"≈íil de Cyclo", img:"oeil de cyclo.png" },
      { key:"Plume de Granduk", img:"plume de granduk.png" },
      { key:"Griffe de Strigide", img:"griffe de strigide.png" },
      { key:"Viande Go√ªtue", img:"viande goutue.png" },
      { key:"Bidoche Go√ªtue", img:"bidoche goutue.png" },
      { key:"√âkl√¢me supr√™me", img:"√âkl√¢me supr√™me.png" },
      { key:"Ceinture de Glourdorak", img:"ceinture glourdorak.png" },
    ],
  },
];

/* =========================================================
   STORAGE HELPERS (donjons)
   ========================================================= */
const kDungeon = (id) => `${LS_PREFIX}${id}`;
function loadDungeonState(id){
  try{
    const raw = localStorage.getItem(kDungeon(id));
    if(!raw) return { mobs:{}, resources:{}, prices:{} };
    const p = JSON.parse(raw);
    return { mobs:p.mobs||{}, resources:p.resources||{}, prices:p.prices||{} };
  }catch(e){ return { mobs:{}, resources:{}, prices:{} }; }
}
function saveDungeonState(id, state){
  localStorage.setItem(kDungeon(id), JSON.stringify(state));
  scheduleCloudSave();
}

/* =========================================================
   CALCULATEUR PP
   ========================================================= */
const kPP = `${LS_PREFIX}pp`;
function loadPPState(){
  try{
    const raw = localStorage.getItem(kPP);
    if(!raw) return { prospection:500, base:12, challenges:60, anomalie:0, shield:5, almanax:0 };
    const p = JSON.parse(raw);
    return {
      prospection: clampNonNeg(p.prospection ?? 500),
      base: clampPct(p.base ?? 12),
      challenges: clampPct(p.challenges ?? 60),
      anomalie: clampPct(p.anomalie ?? 0),
      shield: clampPct(p.shield ?? 5),
      almanax: clampPct(p.almanax ?? 0),
    };
  }catch(e){
    return { prospection:500, base:12, challenges:60, anomalie:0, shield:5, almanax:0 };
  }
}
function savePPState(s){ localStorage.setItem(kPP, JSON.stringify(s)); scheduleCloudSave(); }
function ppMultiplier(prospection){
  const pp = Number(prospection)||0;
  const m = 0.74 + (1.755 / (1 + Math.exp((250 - pp) / 85)));
  return Math.min(2.5, m);
}
function ppFinalDrop(s){
  const mult = ppMultiplier(s.prospection);
  const base = clampPct(s.base);
  const final = base
    * mult
    * (1 + clampPct(s.challenges)/100)
    * (1 + clampPct(s.anomalie)/100)
    * (1 + clampPct(s.shield)/100)
    * (1 + clampPct(s.almanax)/100);
  return { mult, final };
}
function openPPPad(field, label){
  const s = loadPPState();
  const cur = field === "prospection" ? clampNonNeg(s.prospection) : clampNonNeg(s[field]);
  openKeypad(label, cur, (v)=>{
    const st = loadPPState();
    if(field === "prospection") st.prospection = clampNonNeg(v);
    else st[field] = clampPct(v);
    savePPState(st);
    render();
  });
}

/* =========================================================
   CALCULATEUR OMEGA
   ========================================================= */
const kOmega = `${LS_PREFIX}omega`;
function loadOmegaState(){
  try{
    const raw = localStorage.getItem(kOmega);
    if(!raw) return { cur: 472, target: 482 };
    const p = JSON.parse(raw);
    return { cur: clampNonNeg(p.cur ?? 472), target: clampNonNeg(p.target ?? 482) };
  }catch(e){
    return { cur: 472, target: 482 };
  }
}
function saveOmegaState(s){ localStorage.setItem(kOmega, JSON.stringify(s)); scheduleCloudSave(); }
function omegaXpToNext(i){ return Math.round(50000000 * Math.pow(1.01, i)); }
function omegaXpRequired(cur, target){
  cur = clampNonNeg(cur);
  target = clampNonNeg(target);
  if(target <= cur) return 0;
  let sum = 0;
  for(let i=cur; i<target; i++) sum += omegaXpToNext(i);
  return sum;
}
function openOmegaPad(field, label){
  const s = loadOmegaState();
  openKeypad(label, clampNonNeg(s[field]), (v)=>{
    const st = loadOmegaState();
    st[field] = clampNonNeg(v);
    saveOmegaState(st);
    render();
  });
}

/* =========================================================
   SONGES (refait selon tes demandes)
   ========================================================= */
const kSonges = `${LS_PREFIX}songes`;
const SONGES_IMG_DIR = "Songes/";
const BRIBES_ICON_FILE = "Bribe de r√™ve.png";

// 10 intensit√©s = 1..10 (ordre = ce que tu as √† l'√©cran)
const SONGE_INTENSITIES = [
  { id:"reve1",     num:1,  label:"R√™ve 1",     group:"R√™ve",     img:"Reve 1.png" },
  { id:"reve2",     num:2,  label:"R√™ve 2",     group:"R√™ve",     img:"Reve 2.png" },
  { id:"reve3",     num:3,  label:"R√™ve 3",     group:"R√™ve",     img:"Reve 3.png" },

  { id:"paradoxe1", num:4,  label:"Paradoxe 1", group:"Paradoxe", img:"Paradox 1.png" },
  { id:"paradoxe2", num:5,  label:"Paradoxe 2", group:"Paradoxe", img:"Paradox 2.png" },
  { id:"paradoxe3", num:6,  label:"Paradoxe 3", group:"Paradoxe", img:"Paradox 3.png" },
  { id:"paradoxe4", num:7,  label:"Paradoxe 4", group:"Paradoxe", img:"Paradox 4.png" },

  { id:"cauchemar1",num:8,  label:"Cauchemar 1",group:"Cauchemar",img:"Cauchemar 1.png" },
  { id:"cauchemar2",num:9,  label:"Cauchemar 2",group:"Cauchemar",img:"Cauchemar 2.png" },
  { id:"cauchemar3",num:10, label:"Cauchemar 3",group:"Cauchemar",img:"Cauchemar 3.png" },
];

// L√©gendes (ta liste conserv√©e)
const SONGE_LEGENDS = [
  { key:"Oto Mustam",      img:"L√©gende d'Oto Mustam.png",            imgDir: SONGES_IMG_DIR },
  { key:"Menalt",         img:"L√©gende de Menalt.png",                imgDir: SONGES_IMG_DIR },
  { key:"M√©riana",        img:"L√©gende de M√©riana.png",               imgDir: SONGES_IMG_DIR },
  { key:"Jahash",         img:"L√©gende de Jahash Jurgen.png",         imgDir: SONGES_IMG_DIR },
  { key:"Amayiro",        img:"L√©gende d'Amayiro.png",                imgDir: SONGES_IMG_DIR },
  { key:"Dame Jhessica",  img:"L√©gende de Dame Jhessica.png",         imgDir: SONGES_IMG_DIR },
  { key:"Thanatena",      img:"L√©gende de Thanatena.png",             imgDir: SONGES_IMG_DIR },

  { key:"Hels√©phine",     img:"L√©gende d'Hels√©phine.png",             imgDir: SONGES_IMG_DIR },
  { key:"Henual",         img:"L√©gende d'Henual.png",                 imgDir: SONGES_IMG_DIR },
  { key:"Servitude",      img:"L√©gende de Servitude.png",             imgDir: SONGES_IMG_DIR },
  { key:"Guerre",         img:"L√©gende de Guerre.png",                imgDir: SONGES_IMG_DIR },
  { key:"Mis√®re",         img:"L√©gende de Mis√®re.png",                imgDir: SONGES_IMG_DIR },
  { key:"Corruption",     img:"L√©gende de Corruption.png",            imgDir: SONGES_IMG_DIR },
  { key:"Mille Lieues",   img:"L√©gende de Mille Lieues.png",          imgDir: SONGES_IMG_DIR },
  { key:"Rykke Errel",    img:"L√©gende de Rykke Errel.png",           imgDir: SONGES_IMG_DIR },
  { key:"Ganym√®de",       img:"L√©gende de Ganym√®de.png",              imgDir: SONGES_IMG_DIR },
  { key:"Fallanster",     img:"L√©gende de Fallanster.png",            imgDir: SONGES_IMG_DIR },
  { key:"Crocobur",       img:"L√©gende de Crocobur.png",              imgDir: SONGES_IMG_DIR },
  { key:"Dodge",          img:"L√©gende de Dodge.png",                 imgDir: SONGES_IMG_DIR },
  { key:"Br√¢m Barbe-Monde",img:"L√©gende de Br√¢m Barbe-Monde.png",     imgDir: SONGES_IMG_DIR },
  { key:"Brumaire",       img:"L√©gende de Brumaire.png",              imgDir: SONGES_IMG_DIR },
  { key:"Buhorado",       img:"L√©gende de Buhorado.png",              imgDir: SONGES_IMG_DIR },
  { key:"Cul Bott√©",      img:"L√©gende du Cul Bott√©.png",             imgDir: SONGES_IMG_DIR },
  { key:"Destin",         img:"L√©gende du Destin.png",                imgDir: SONGES_IMG_DIR },
  { key:"Miroir",         img:"L√©gende du Miroir.png",                imgDir: SONGES_IMG_DIR },
  { key:"Trompe-la-Mort", img:"L√©gende du Trompe-la-Mort.png",        imgDir: SONGES_IMG_DIR },

  { key:"Kwakarticho",    img:"L√©gende animale de Kwakarticho.png",   imgDir: SONGES_IMG_DIR },
  { key:"Poukachi",       img:"L√©gende animale de Poukachi.png",      imgDir: SONGES_IMG_DIR },
  { key:"Bakushana",      img:"L√©gende animale de Bakushana.png",     imgDir: SONGES_IMG_DIR },
  { key:"Magicrabe",      img:"L√©gende animale de Magicrabe.png",     imgDir: SONGES_IMG_DIR },
];

function blankSongesState(){
  const init = {
    ui: { tab:"runs", search:"" },
    bribesTotal: 0,
    runs: {},
    bribesByIntensity: {}, // 1..10
    legends: {},
  };
  SONGE_INTENSITIES.forEach(x=>{
    init.runs[x.id] = 0;
    init.bribesByIntensity[String(x.num)] = 0;
  });
  SONGE_LEGENDS.forEach(x=>init.legends[x.key]=0);
  return init;
}
function loadSongesState(){
  try{
    const raw = localStorage.getItem(kSonges);
    if(!raw) return blankSongesState();
    const p = JSON.parse(raw);

    const out = blankSongesState();
    out.ui = p.ui || out.ui;
    out.bribesTotal = clampNonNeg(p.bribesTotal ?? 0);

    // runs
    if(p.runs){
      for(const it of SONGE_INTENSITIES){
        out.runs[it.id] = clampNonNeg(p.runs[it.id] ?? 0);
      }
    }
    // bribes by intensity
    if(p.bribesByIntensity){
      for(const it of SONGE_INTENSITIES){
        out.bribesByIntensity[String(it.num)] = clampNonNeg(p.bribesByIntensity[String(it.num)] ?? 0);
      }
    }

    // legends
    if(p.legends){
      for(const l of SONGE_LEGENDS){
        out.legends[l.key] = clampNonNeg(p.legends[l.key] ?? 0);
      }
    }
    return out;
  }catch(e){
    return blankSongesState();
  }
}
function saveSongesState(s){
  localStorage.setItem(kSonges, JSON.stringify(s));
  scheduleCloudSave();
}

window.resetSonges = function(){
  if(!confirm("Reset Songes (runs + bribes + l√©gendes) ?")) return;
  localStorage.removeItem(kSonges);
  scheduleCloudSave();
  render();
};

function setSongesTab(tab){
  const s = loadSongesState();
  s.ui.tab = tab;
  saveSongesState(s);
  renderSonges();
}
function setSongesSearch(value){
  const s = loadSongesState();
  s.ui.search = String(value||"");
  saveSongesState(s);
  renderSonges();
}

// Bribes global set (click value)
window.openSongesBribesPad = function(){
  const s = loadSongesState();
  openKeypad("Bribes (global) ‚Äî d√©finir total", clampNonNeg(s.bribesTotal), (v)=>{
    const st = loadSongesState();
    st.bribesTotal = clampNonNeg(v);
    saveSongesState(st);
    renderSonges();
  });
};

// Runs pad (click number)
window.openSongesRunPad = function(intensityId, label){
  const s = loadSongesState();
  openKeypad(`Runs ‚Ä¢ ${label}`, clampNonNeg(s.runs[intensityId] ?? 0), (v)=>{
    const st = loadSongesState();
    st.runs[intensityId] = clampNonNeg(v);
    saveSongesState(st);
    renderSonges();
  });
};

// +Run = +1 RUN ONLY
window.songeIncRun = function(intensityId){
  const st = loadSongesState();
  st.runs[intensityId] = clampNonNeg((st.runs[intensityId] ?? 0) + 1);
  saveSongesState(st);
  renderSonges();
};
window.songeDecRun = function(intensityId){
  const st = loadSongesState();
  st.runs[intensityId] = clampNonNeg((st.runs[intensityId] ?? 0) - 1);
  saveSongesState(st);
  renderSonges();
};

// Add bribes: asks intensity (1..10) then amount
window.songeAddBribes = function(){
  openKeypad("Intensit√© (1 √† 10)", 1, (inten)=>{
    inten = clampNonNeg(inten);
    if(inten < 1 || inten > 10){
      alert("Intensit√© invalide. Choisis un nombre entre 1 et 10.");
      return;
    }
    openKeypad(`Ajouter bribes ‚Ä¢ Intensit√© ${inten}`, 0, (amount)=>{
      const add = clampNonNeg(amount);
      const st = loadSongesState();
      st.bribesTotal = clampNonNeg((st.bribesTotal ?? 0) + add);
      st.bribesByIntensity[String(inten)] = clampNonNeg((st.bribesByIntensity[String(inten)] ?? 0) + add);
      saveSongesState(st);
      renderSonges();
    });
  });
};

// Remove bribes: asks intensity (1..10) then amount
window.songeSubBribes = function(){
  openKeypad("Intensit√© (1 √† 10)", 1, (inten)=>{
    inten = clampNonNeg(inten);
    if(inten < 1 || inten > 10){
      alert("Intensit√© invalide. Choisis un nombre entre 1 et 10.");
      return;
    }
    openKeypad(`Retirer bribes ‚Ä¢ Intensit√© ${inten}`, 0, (amount)=>{
      const sub = clampNonNeg(amount);
      const st = loadSongesState();
      st.bribesTotal = clampNonNeg((st.bribesTotal ?? 0) - sub);
      st.bribesByIntensity[String(inten)] = clampNonNeg((st.bribesByIntensity[String(inten)] ?? 0) - sub);
      saveSongesState(st);
      renderSonges();
    });
  });
};

// Legends
window.songeIncLegend = function(key){
  const st = loadSongesState();
  st.legends[key] = clampNonNeg((st.legends[key] ?? 0) + 1);
  saveSongesState(st);
  renderSonges();
};
window.songeDecLegend = function(key){
  const st = loadSongesState();
  st.legends[key] = clampNonNeg((st.legends[key] ?? 0) - 1);
  saveSongesState(st);
  renderSonges();
};
window.openLegendPad = function(key){
  const s = loadSongesState();
  openKeypad(`L√©gende ‚Ä¢ ${key}`, clampNonNeg(s.legends[key] ?? 0), (v)=>{
    const st = loadSongesState();
    st.legends[key] = clampNonNeg(v);
    saveSongesState(st);
    renderSonges();
  });
};

function renderSonges(){
  const s = loadSongesState();
  pagePill.textContent = "Songes";

  const tab = s.ui?.tab || "runs";
  const totalRuns = Object.values(s.runs||{}).reduce((a,b)=>a+n(b),0);
  const bribesTotal = clampNonNeg(s.bribesTotal ?? 0);

  const header = `
    <div class="topline">
      <div class="title">
        <div class="logo" style="width:42px;height:42px;border-radius:16px">üåô</div>
        <div>
          <h2>Songes</h2>
          <p class="sub">Runs par intensit√© ‚Ä¢ Bribes globales ‚Ä¢ Bribes cumul√©es par intensit√© ‚Ä¢ L√©gendes dropp√©es.</p>
        </div>
      </div>
      <div class="nav">
        <button class="btn gold" onclick="songeAddBribes()">‚ûï Ajouter des bribes</button>
        <button class="btn" onclick="songeSubBribes()">‚ûñ Retirer des bribes</button>
        <button class="btn bad" onclick="resetSonges()">üßπ Reset Songes</button>
      </div>
    </div>
  `;

  const tabs = `
    <div class="seg" style="margin-bottom:12px">
      <button class="btn small ${tab==='runs'?'active':''}" onclick="setSongesTab('runs')">üìä Runs & Bribes</button>
      <button class="btn small ${tab==='legends'?'active':''}" onclick="setSongesTab('legends')">üè∑Ô∏è L√©gendes</button>
    </div>
  `;

  const bribesKpiIcon = `
    <span class="kico">
      <img data-file="${escapeHtml(BRIBES_ICON_FILE)}" data-dir="" alt="">
    </span>
  `;

  const topKpis = `
    <div class="summary" style="margin-top:0">
      <div class="kpi">
        <div class="k">Bribes (global) ${bribesKpiIcon}</div>
        <div class="v mono gold" style="cursor:pointer" onclick="openSongesBribesPad()">${fmt.format(bribesTotal)}</div>
      </div>
      <div class="kpi">
        <div class="k">Runs (total)</div>
        <div class="v mono">${fmt.format(totalRuns)}</div>
      </div>
      <div class="kpi">
        <div class="k">Mode</div>
        <div class="v mono">+Run = +1 run</div>
      </div>
      <div class="kpi">
        <div class="k">Astuce</div>
        <div class="v mono">Bribes via bouton d√©di√©</div>
      </div>
    </div>
  `;

  let body = "";

  if(tab === "runs"){
    const byGroup = (group) => SONGE_INTENSITIES.filter(x=>x.group===group);

    const groupBlock = (groupName) => {
      const rows = byGroup(groupName).map(it=>{
        const count = clampNonNeg(s.runs[it.id] ?? 0);
        const bsum = clampNonNeg(s.bribesByIntensity[String(it.num)] ?? 0);

        return `
          <div class="item">
            <div class="ico">
              <img data-file="${escapeHtml(it.img)}" data-dir="${escapeHtml(SONGES_IMG_DIR)}" alt="">
            </div>
            <div class="name">
              <p class="n">${escapeHtml(it.label)}</p>
              <p class="m">Bribes cumul√©es : <b class="mono">${fmt.format(bsum)}</b> <span class="pill" style="padding:4px 8px;border-radius:999px">Int. ${it.num}</span></p>
            </div>
            <div class="ctrls">
              <button class="btn small" onclick="songeDecRun('${it.id}')">‚àí</button>
              <div class="num" onclick="openSongesRunPad('${it.id}','${jsEscape(it.label)}')">${fmt.format(count)}</div>
              <button class="btn small gold" onclick="songeIncRun('${it.id}')">+ Run</button>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="calcBox" style="margin-bottom:14px">
          <div class="calcHead">${escapeHtml(groupName.toUpperCase())}</div>
          <div class="calcBody">
            <div class="list">${rows}</div>
          </div>
        </div>
      `;
    };

    // layout demand√©: Cauchemar sous les bribes (colonne droite)
    body = `
      <div class="row">
        <div>
          ${groupBlock("R√™ve")}
          ${groupBlock("Paradoxe")}
        </div>

        <div>
          <div class="calcRightBig">
            <div class="t">BRIBES (GLOBAL)</div>
            <div class="v" onclick="openSongesBribesPad()">
              <img data-file="${escapeHtml(BRIBES_ICON_FILE)}" style="width:26px;height:26px;object-fit:contain" alt="">
              ${fmt.format(bribesTotal)}
            </div>
            <div class="calcNote" style="text-align:center">
              Clique sur la valeur pour <b>d√©finir le total</b>.<br>
              Pour ajouter, utilise <b>‚ÄúAjouter des bribes‚Äù</b> ‚Üí tu choisis l‚Äôintensit√© (1..10) ‚Üí √ßa cumule partout.
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="section">
            <div class="topline" style="margin-bottom:8px">
              <div class="pill">Notes</div>
              <div class="pill">Bribes li√©es aux vagues</div>
            </div>
            <div class="hint" style="margin-top:0">
              Apr√®s la 3.5, les bribes d√©pendent des vagues. Ici : tu saisis <b>les bribes r√©elles</b> et tu les classes par intensit√©.
            </div>
          </div>

          <div style="height:14px"></div>

          ${groupBlock("Cauchemar")}
        </div>
      </div>
    `;
  }

  if(tab === "legends"){
    const q = (s.ui?.search || "").toLowerCase().trim();

    const tiles = SONGE_LEGENDS
      .filter(l => !q || l.key.toLowerCase().includes(q))
      .map(l=>{
        const val = clampNonNeg(s.legends[l.key] ?? 0);
        return `
          <div class="item legendItem">
            <div class="ico">
              <img data-file="${escapeHtml(l.img)}" data-dir="${escapeHtml(l.imgDir || SONGES_IMG_DIR)}" alt="">
            </div>
            <div class="name">
              <p class="n">${escapeHtml(l.key)}</p>
              <p class="m">Compteur de drop l√©gendaire</p>
            </div>
            <div class="ctrls">
              <button class="btn small" onclick="songeDecLegend('${jsEscape(l.key)}')">‚àí</button>
              <div class="num" onclick="openLegendPad('${jsEscape(l.key)}')">${fmt.format(val)}</div>
              <button class="btn small" onclick="songeIncLegend('${jsEscape(l.key)}')">+</button>
            </div>
          </div>
        `;
      }).join("");

    const doneCount = SONGE_LEGENDS.reduce((acc,l)=> acc + (clampNonNeg(s.legends[l.key] ?? 0) > 0 ? 1 : 0), 0);

    body = `
      <div class="section">
        <div class="topline">
          <div class="title">
            <div class="pill">üìö Classement</div>
            <div class="pill">D√©j√† drop: <b class="mono">${fmt.format(doneCount)}</b> / <b class="mono">${fmt.format(SONGE_LEGENDS.length)}</b></div>
          </div>
          <div class="searchRow">
            <input placeholder="Rechercher une l√©gende‚Ä¶" value="${escapeHtml(s.ui?.search||"")}"
              oninput="setSongesSearch(this.value)">
            <button class="btn small" onclick="setSongesSearch('')">‚úñ</button>
          </div>
        </div>

        <div class="legendGrid">
          ${tiles || ``}
        </div>

        ${tiles ? "" : `<div class="hint">Aucune l√©gende trouv√©e.</div>`}
      </div>
    `;
  }

  app.innerHTML = `
    <div class="section">
      ${header}
      ${tabs}
      ${topKpis}
      <div style="height:14px"></div>
      ${body}
    </div>
  `;

  activateFallbackIn(app, "");
}

/* =========================================================
   PAGES: HOME / DONJONS / PP / OMEGA / DUNGEON
   ========================================================= */
function renderHomePage(){
  pagePill.textContent = "Accueil";
  app.innerHTML = `
    <div class="section">
      <div class="topline">
        <div class="title">
          <div class="logo" style="width:42px;height:42px;border-radius:16px">üè†</div>
          <div>
            <h2>Home</h2>
            <p class="sub">Choisis une cat√©gorie.</p>
          </div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="card-left">
            <div class="thumb"><span style="color:var(--gold);font-weight:900">‚öîÔ∏è</span></div>
            <div style="min-width:0">
              <h3>Donjons</h3>
              <p>Liste Comte / Tork√© / D√©chireuse‚Ä¶</p>
            </div>
          </div>
          <div class="card-right">
            <button class="btn small gold" onclick="location.hash='#/donjons'">Ouvrir</button>
          </div>
        </div>

        <div class="card">
          <div class="card-left">
            <div class="thumb"><span style="color:var(--gold);font-weight:900">üåô</span></div>
            <div style="min-width:0">
              <h3>Songes</h3>
              <p>Runs par intensit√© ‚Ä¢ Bribes par intensit√© (1..10) ‚Ä¢ L√©gendes.</p>
            </div>
          </div>
          <div class="card-right">
            <button class="btn small gold" onclick="location.hash='#/songes'">Ouvrir</button>
          </div>
        </div>

        <div class="card">
          <div class="card-left">
            <div class="thumb"><span style="color:var(--gold);font-weight:900">üåÄ</span></div>
            <div style="min-width:0">
              <h3>Anomalies</h3>
              <p>√Ä venir.</p>
            </div>
          </div>
          <div class="card-right">
            <button class="btn small gold" onclick="location.hash='#/anomalies'">Ouvrir</button>
          </div>
        </div>

        <div class="card">
          <div class="card-left">
            <div class="thumb"><span style="color:var(--gold);font-weight:900">üìå</span></div>
            <div style="min-width:0">
              <h3>Calculateur PP</h3>
              <p>Prospection ‚Üí multiplicateur ‚Üí taux final.</p>
            </div>
          </div>
          <div class="card-right">
            <button class="btn small gold" onclick="location.hash='#/pp'">Ouvrir</button>
          </div>
        </div>

        <div class="card">
          <div class="card-left">
            <div class="thumb"><span style="color:var(--gold);font-weight:900">üìà</span></div>
            <div style="min-width:0">
              <h3>Calculateur XP Om√©ga</h3>
              <p>Omega actuel ‚Üí objectif ‚Üí XP totale.</p>
            </div>
          </div>
          <div class="card-right">
            <button class="btn small gold" onclick="location.hash='#/omega'">Ouvrir</button>
          </div>
        </div>
      </div>

      <div class="hint">
        Mode cloud : clique sur <b>Connexion</b> (magic link) ‚Üí sauvegarde/charge sur Supabase.
      </div>
    </div>
  `;
}

function renderPlaceholder(title, desc){
  pagePill.textContent = title;
  app.innerHTML = `
    <div class="section">
      <div class="topline">
        <div class="title">
          <div class="logo" style="width:42px;height:42px;border-radius:16px">‚Äî</div>
          <div>
            <h2>${escapeHtml(title)}</h2>
            <p class="sub">${escapeHtml(desc)}</p>
          </div>
        </div>
      </div>
      <div class="hint">Page placeholder.</div>
    </div>
  `;
}

function renderDonjonsList(){
  pagePill.textContent = "Donjons";
  const cards = DUNGEONS.map(d=>{
    const state = loadDungeonState(d.id);
    const mobsTotal = Object.values(state.mobs||{}).reduce((a,b)=>a+n(b),0);
    const resTotal  = Object.values(state.resources||{}).reduce((a,b)=>a+n(b),0);

    return `
      <div class="card">
        <div class="card-left">
          <div class="thumb">
            ${d.thumb
              ? `<img data-file="${escapeHtml(d.thumb)}" data-dir="${escapeHtml(d.imgDir)}" alt="">`
              : `<span style="color:var(--gold);font-weight:800">DJ</span>`}
          </div>
          <div style="min-width:0">
            <h3>${escapeHtml(d.name)}</h3>
            <p>Mobs: <b class="mono">${fmt.format(mobsTotal)}</b> ‚Ä¢ Ressources: <b class="mono">${fmt.format(resTotal)}</b></p>
          </div>
        </div>
        <div class="card-right">
          <button class="btn small gold" onclick="location.hash='#/d/${d.id}'">Ouvrir</button>
          <button class="btn small bad" onclick="resetDungeon('${d.id}')">Reset</button>
        </div>
      </div>
    `;
  }).join("");

  app.innerHTML = `
    <div class="section">
      <div class="topline">
        <div class="title">
          <div class="logo" style="width:42px;height:42px;border-radius:16px">‚öîÔ∏è</div>
          <div>
            <h2>Donjons</h2>
            <p class="sub">Comte / Tork√© / D√©chireuse‚Ä¶</p>
          </div>
        </div>
        <div class="nav">
          <span class="pill">Astuce: clique sur un nombre ‚Üí pav√© num√©rique</span>
        </div>
      </div>
      <div class="grid">${cards}</div>
      <div class="hint">
        Les images doivent √™tre dans les dossiers <b>D√©chireuse/</b>, <b>Tork√©lonia/</b>, etc.
      </div>
    </div>
  `;

  activateFallbackIn(app, "");
}

function renderPP(){
  const s = loadPPState();
  const { mult, final } = ppFinalDrop(s);
  pagePill.textContent = "Calculateur PP";

  app.innerHTML = `
    <div class="section">
      <div class="topline">
        <div class="title">
          <div class="logo" style="width:42px;height:42px;border-radius:16px">üìå</div>
          <div>
            <h2>Calculateur PP</h2>
            <p class="sub">Modifiables : PP / Base / Challenges / Anomalie / Shield / Almanax ‚Ä¢ Le reste est calcul√©.</p>
          </div>
        </div>
        <div class="nav">
          <button class="btn bad" onclick="resetPP()">üßπ Reset</button>
        </div>
      </div>

      <div class="calc3">
        <div class="calcBox">
          <div class="calcHead">PROSPECTION</div>
          <div class="calcBody">
            <div class="calcValue" onclick="openPPPad('prospection','Prospection')">${fmt.format(s.prospection)}</div>

            <div style="height:10px"></div>

            <div class="calcRow" style="grid-template-columns:1fr;gap:6px">
              <div>
                <div class="lab">MULTIPLICATEUR DROP</div>
                <div class="sub">MAX = 2.5</div>
              </div>
              <div class="calcValue static" style="margin-top:8px">${f2(mult)}</div>
            </div>

            <div class="calcNote">
              Formule : <span class="mono">0.74 + (1.755 / (1 + e^((250 - PP)/85)))</span>
            </div>
          </div>
        </div>

        <div class="calcBox">
          <div class="calcHead">% BONUS / TAUX</div>
          <div class="calcBody">
            <div class="calcStack">
              ${ppPctRow("üß™","% TAUX DE DROP DE BASE", "base", s.base)}
              ${ppPctRow("üß©","% CHALLENGES", "challenges", s.challenges)}
              ${ppPctRow("üåÄ","% ANOMALIE", "anomalie", s.anomalie)}
              ${ppPctRow("üõ°Ô∏è","% ANKAMA SHIELD", "shield", s.shield)}
              ${ppPctRow("üìÖ","% ALMANAX", "almanax", s.almanax)}
            </div>

            <div class="hint" style="margin-top:12px">
              Astuce : tu peux taper au clavier dans les champs % (virgule OK). La PP se fait au pav√© num√©rique.
            </div>
          </div>
        </div>

        <div class="calcRightBig">
          <div class="t">% TAUX DE DROP FINAL</div>
          <div class="v" style="cursor:default">${f2(final)}</div>
          <div class="calcNote" style="text-align:center">
            R√©sultat = Base √ó Mult √ó (1+Chall) √ó (1+Ano) √ó (1+Shield) √ó (1+Almanax)
          </div>
        </div>
      </div>
    </div>
  `;
}
function ppPctRow(icon, label, field, val){
  const v = (Number(val)||0);
  const display = f2(v).replace(".", ",");
  return `
    <div class="calcRow">
      <div><div class="lab">${escapeHtml(label)}</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="pill" style="border-color:rgba(214,179,106,.25);background:rgba(214,179,106,.06)">${escapeHtml(icon)}</span>
        <input class="field fieldPct" inputmode="decimal"
          value="${escapeHtml(display)}"
          oninput="setPPFieldLive('${field}', this.value)"
          onfocus="this.select()"
          title="${escapeHtml(label)}">
      </div>
    </div>
  `;
}
window.setPPFieldLive = function(field, value){
  const s = loadPPState();
  s[field] = clampPct(value);
  savePPState(s);
  renderPP();
};
window.resetPP = function(){
  if(!confirm("Reset le calculateur PP ?")) return;
  localStorage.removeItem(kPP);
  scheduleCloudSave();
  render();
};

function renderOmega(){
  const s = loadOmegaState();
  const xp = omegaXpRequired(s.cur, s.target);
  pagePill.textContent = "XP Om√©ga";

  app.innerHTML = `
    <div class="section">
      <div class="topline">
        <div class="title">
          <div class="logo" style="width:42px;height:42px;border-radius:16px">üìà</div>
          <div>
            <h2>Calculateur XP Om√©ga</h2>
            <p class="sub">Modifiables : Om√©ga actuel + Om√©ga souhait√© ‚Ä¢ R√©sultat : XP √† faire.</p>
          </div>
        </div>
        <div class="nav">
          <button class="btn bad" onclick="resetOmega()">üßπ Reset</button>
        </div>
      </div>

      <div class="calc3">
        <div class="calcBox">
          <div class="calcHead">OMEGA ACTUEL</div>
          <div class="calcBody">
            <div class="calcValue" onclick="openOmegaPad('cur','Omega actuel')">${fmt.format(s.cur)}</div>
            <div class="calcNote">Clique pour saisir au pav√© num√©rique.</div>
          </div>
        </div>

        <div class="calcBox">
          <div class="calcHead">OMEGA SOUHAIT√â</div>
          <div class="calcBody">
            <div class="calcValue" onclick="openOmegaPad('target','Omega souhait√©')">${fmt.format(s.target)}</div>
            <div class="calcNote">Si l‚Äôobjectif ‚â§ actuel ‚Üí 0 XP.</div>
          </div>
        </div>

        <div class="calcRightBig">
          <div class="t">POINTS D‚ÄôEXP√âRIENCE REQUIS</div>
          <div class="v" style="cursor:default">${fmt.format(xp)} xp</div>
          <div class="calcNote" style="text-align:center">
            Mod√®le : <span class="mono">xpNext(i) = round(50 000 000 √ó 1.01^i)</span>
          </div>
        </div>
      </div>

      <div class="hint">
        (Info) Om√©ga = niveaux apr√®s 200 (Œ©1, Œ©2, ‚Ä¶). Ici on calcule l‚ÄôXP √† gagner entre deux om√©gas.
      </div>
    </div>
  `;
}
window.resetOmega = function(){
  if(!confirm("Reset le calculateur XP Om√©ga ?")) return;
  localStorage.removeItem(kOmega);
  scheduleCloudSave();
  render();
};

function renderDungeon(d){
  pagePill.textContent = d.name;
  const state = loadDungeonState(d.id);

  const mobsHtml = (d.mobs||[]).map(m=>{
    const val = clampNonNeg(state.mobs[m.key] ?? 0);
    return renderCounterRow({
      dungeonId:d.id,
      title:m.key,
      subtitle:"Monstre",
      imgFile:m.img,
      imgDir:d.imgDir,
      value:val,
    });
  }).join("");

  const resHtml = (d.resources||[]).map(r=>{
    const count = clampNonNeg(state.resources[r.key] ?? 0);
    const price = clampNonNeg(state.prices[r.key] ?? 0);
    const subtotal = count * price;

    return `
      <div class="item">
        <div class="ico">
          ${r.img ? `<img data-file="${escapeHtml(r.img)}" data-dir="${escapeHtml(d.imgDir)}" alt="">` : ""}
        </div>
        <div class="name">
          <p class="n">${escapeHtml(r.key)}</p>
          <p class="m">Sous-total: <b class="mono">${fmt.format(subtotal)}</b></p>
        </div>
        <div class="ctrls">
          <button class="btn small" onclick="decRes('${d.id}', '${jsEscape(r.key)}')">‚àí</button>
          <div class="num" onclick="openResPad('${d.id}', '${jsEscape(r.key)}')">${fmt.format(count)}</div>
          <button class="btn small" onclick="incRes('${d.id}', '${jsEscape(r.key)}')">+</button>
          <input class="field mini" inputmode="numeric" pattern="[0-9]*"
                 value="${price}"
                 title="Prix moyen"
                 onchange="setPrice('${d.id}','${jsEscape(r.key)}', this.value)"
                 onfocus="this.select()">
        </div>
      </div>
    `;
  }).join("");

  const mobsTotal = Object.values(state.mobs||{}).reduce((a,b)=>a+n(b),0);
  const resTotal  = Object.values(state.resources||{}).reduce((a,b)=>a+n(b),0);
  const kamaTotal = (d.resources||[]).reduce((sum,r)=>{
    const c = clampNonNeg(state.resources[r.key] ?? 0);
    const p = clampNonNeg(state.prices[r.key] ?? 0);
    return sum + (c*p);
  },0);

  const hasTotalBtn = d.totalIncrements && Object.keys(d.totalIncrements).length > 0;

  app.innerHTML = `
    <div class="section">
      <div class="topline">
        <div class="title">
          <div class="thumb" style="width:48px;height:48px;border-radius:18px">
            ${d.thumb ? `<img data-file="${escapeHtml(d.thumb)}" data-dir="${escapeHtml(d.imgDir)}" alt="">` : `<span style="color:var(--gold);font-weight:800">DJ</span>`}
          </div>
          <div style="min-width:0">
            <h2>${escapeHtml(d.name)}</h2>
            <p class="sub">Clique sur un nombre pour saisir au pav√© num√©rique. Sauvegarde auto.</p>
          </div>
        </div>
        <div class="nav">
          ${hasTotalBtn ? `<button class="btn gold" onclick="applyTotalRun('${d.id}')">‚ûï ${escapeHtml(d.totalButtonLabel)}</button>` : ""}
          <button class="btn" onclick="exportDungeon('${d.id}')">üì§ Export JSON</button>
          <button class="btn bad" onclick="resetDungeon('${d.id}')">üßπ Reset</button>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="topline" style="margin-bottom:10px">
            <div class="pill">Monstres</div>
            <div class="pill">Total: <b class="mono">${fmt.format(mobsTotal)}</b></div>
          </div>
          <div class="list">${mobsHtml || `<div class="hint">Aucun monstre configur√© ici.</div>`}</div>
        </div>

        <div>
          <div class="topline" style="margin-bottom:10px">
            <div class="pill">Ressources (compte + prix moyen)</div>
            <div class="pill">Total: <b class="mono">${fmt.format(resTotal)}</b> ‚Ä¢ Kamas: <b class="mono" style="color:var(--gold)">${fmt.format(kamaTotal)}</b></div>
          </div>
          <div class="list">${resHtml || `<div class="hint">Aucune ressource configur√©e ici.</div>`}</div>
        </div>
      </div>

      <div class="summary">
        <div class="kpi"><div class="k">Total mobs</div><div class="v mono">${fmt.format(mobsTotal)}</div></div>
        <div class="kpi"><div class="k">Total ressources</div><div class="v mono">${fmt.format(resTotal)}</div></div>
        <div class="kpi"><div class="k">Valeur estim√©e</div><div class="v mono gold">${fmt.format(kamaTotal)}</div></div>
        <div class="kpi"><div class="k">Dossier images</div><div class="v mono">${escapeHtml(d.imgDir)}</div></div>
      </div>
    </div>
  `;

  activateFallbackIn(app, d.imgDir);
}

function renderCounterRow({dungeonId,title,subtitle,imgFile,imgDir,value}){
  const safeTitle = jsEscape(title);
  return `
    <div class="item">
      <div class="ico">
        ${imgFile ? `<img data-file="${escapeHtml(imgFile)}" data-dir="${escapeHtml(imgDir)}" alt="">` : ""}
      </div>
      <div class="name">
        <p class="n">${escapeHtml(title)}</p>
        <p class="m">${escapeHtml(subtitle)}</p>
      </div>
      <div class="ctrls">
        <button class="btn small" onclick="decMob('${dungeonId}','${safeTitle}')">‚àí</button>
        <div class="num" onclick="openMobPad('${dungeonId}','${safeTitle}')">${fmt.format(value)}</div>
        <button class="btn small" onclick="incMob('${dungeonId}','${safeTitle}')">+</button>
      </div>
    </div>
  `;
}

/* =========================================================
   ACTIONS EXPOSED (donjons)
   ========================================================= */
window.resetDungeon = function(id){
  if(!confirm(`Reset les donn√©es du donjon "${id}" ?`)) return;
  localStorage.removeItem(kDungeon(id));
  scheduleCloudSave();
  render();
}
window.exportDungeon = function(id){
  const d = DUNGEONS.find(x=>x.id===id);
  const state = loadDungeonState(id);
  const payload = { id, name:d?.name, state, exportedAt:new Date().toISOString() };
  navigator.clipboard?.writeText(JSON.stringify(payload, null, 2)).catch(()=>{});
  alert("Export copi√© dans le presse-papiers (JSON) ‚úÖ");
}
window.applyTotalRun = function(id){
  const d = DUNGEONS.find(x=>x.id===id);
  if(!d || !d.totalIncrements) return;
  const state = loadDungeonState(id);
  state.mobs ||= {};
  Object.entries(d.totalIncrements).forEach(([mob, inc])=>{
    const cur = clampNonNeg(state.mobs[mob] ?? 0);
    state.mobs[mob] = clampNonNeg(cur + inc);
  });
  saveDungeonState(id, state);
  render();
}

window.incMob = function(id, key){
  const state = loadDungeonState(id);
  state.mobs ||= {};
  state.mobs[key] = clampNonNeg((state.mobs[key] ?? 0) + 1);
  saveDungeonState(id,state); render();
}
window.decMob = function(id, key){
  const state = loadDungeonState(id);
  state.mobs ||= {};
  state.mobs[key] = clampNonNeg((state.mobs[key] ?? 0) - 1);
  saveDungeonState(id,state); render();
}
window.openMobPad = function(id, key){
  const state = loadDungeonState(id);
  const cur = clampNonNeg(state.mobs?.[key] ?? 0);
  openKeypad(`Monstre ‚Ä¢ ${key}`, cur, (v)=>{
    const st = loadDungeonState(id);
    st.mobs ||= {};
    st.mobs[key] = v;
    saveDungeonState(id, st);
    render();
  });
}

window.incRes = function(id, key){
  const state = loadDungeonState(id);
  state.resources ||= {};
  state.resources[key] = clampNonNeg((state.resources[key] ?? 0) + 1);
  saveDungeonState(id,state); render();
}
window.decRes = function(id, key){
  const state = loadDungeonState(id);
  state.resources ||= {};
  state.resources[key] = clampNonNeg((state.resources[key] ?? 0) - 1);
  saveDungeonState(id,state); render();
}
window.openResPad = function(id, key){
  const state = loadDungeonState(id);
  const cur = clampNonNeg(state.resources?.[key] ?? 0);
  openKeypad(`Ressource ‚Ä¢ ${key}`, cur, (v)=>{
    const st = loadDungeonState(id);
    st.resources ||= {};
    st.resources[key] = v;
    saveDungeonState(id, st);
    render();
  });
}
window.setPrice = function(id, key, val){
  const state = loadDungeonState(id);
  state.prices ||= {};
  state.prices[key] = clampNonNeg(val);
  saveDungeonState(id,state); render();
}

/* =========================================================
   RENDER ROOT
   ========================================================= */
function render(){
  const r = getRoute();

  if(r.page === "home") return renderHomePage();
  if(r.page === "donjons") return renderDonjonsList();
  if(r.page === "songes") return renderSonges();
  if(r.page === "anomalies") return renderPlaceholder("Anomalies", "Espace Anomalies (√† venir).");
  if(r.page === "pp") return renderPP();
  if(r.page === "omega") return renderOmega();

  if(r.page === "dungeon"){
    const d = DUNGEONS.find(x=>x.id===r.id);
    if(!d) { location.hash="#/"; return; }
    return renderDungeon(d);
  }

  renderHomePage();
}

/* =========================================================
   HELPERS
   ========================================================= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c=>(
    c==="&"?"&amp;":c==="<"?"&lt;":c===">"?"&gt;":c==='"'?"&quot;":"&#39;"
  ));
}
function jsEscape(s){
  return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}

/* =========================================================
   BOOT
   ========================================================= */
(async function boot(){
  // images fallback in header too (navbar icons)
 activateFallbackIn(document.getElementById("topHeader"), "");
if (app) activateFallbackIn(app, "");
  await initAuth();
  render();
  // fallback in first render
  activateFallbackIn(app, "");
})();
</script>
</body>
</html>
